<!DOCTYPE html>
<html lang="en">

<head>
  <title>Pertinent Impressive Mink</title>
  <meta property="og:title" content="Pertinent Impressive Mink" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <meta property="twitter:card" content="summary_large_image" />

  <script src="../jscript/pfcUtils.js"></script>
  <script src="../jscript/jquery-3.1.0.js"></script>
  <script src="../jscript/wl_header.js">
    document.writeln("Error loading Pro/Web.Link header!");
  </script>
  <link href="./style.css" rel="stylesheet" />
  <link href="./home.css" rel="stylesheet" />
  <link rel="stylesheet" href="milligram.css">
  <link rel="stylesheet" href="milligram.min.css">
</head>

<body>
  <div>
    <div class="home-container">
      <form name="JOB INFOR" class="home-form">
        <div class="home-container2">
          <label class="home-text5">JOB:</label>
          <input id="JOB" type="text" class="home-textinput1 input" />

          <label class="home-text1">MN TYPE:</label>
          <select id="MNTYPE" class="home-select">
            <option value="Option 2">SDQ</option>
            <option value="Option 3">RQEW</option>
            <option id="SMN" value="SMN">SMN</option>
          </select>
        </div>
        <div class="home-container2">
          <label class="home-text1">MN #:</label>
          <input id="MN" type="text" class="home-textinput input" />

          <label class="home-text1">LINE #:</label>
          <input id="LINE" type="text" class="home-textinput input" />
        </div>
        <div class="home-container2">
          <label class="home-text1">REV:</label>
          <input id="REV" type="text" class="home-textinput input" />

          <label class="home-text1">PCR #:</label>
          <input id="PCR" type="text" class="home-textinput input" />
        </div>
        <div class="home-container2">
          <label class="home-text6">MBPP:</label>
          <input id="MBPP" type="text" class="home-textinput1 input" />

          <button class="home-button button" type="button" onclick="updateJobInFor()">Update JobInFor</button>
        </div>
      </form>

      <form class="home-form1">
        <div class="home-container3">
          <label class="home-text2">EXISTING PROG#:</label>
          <textarea id="PROG" class="home-textarea textarea"></textarea>
        </div>
        <div class="home-container4">
          <label class="home-text3">PROGRAM NUMBERS TO BOOK:</label>
          <input id="BOOKNUM" type="text" class="home-textinput2 input" />
          <button id="BookNumbers" class="home-button2 button" type="button">BOOK PROGRAM NUMBERS</button>
          <button class="home-button2 button" type="button">SAVE PROGRAM NUMBERS TO CREO DRAWING</button>
          <button class="home-button2 button" type="button">EXPORT SETUP SHEETS(PDF)</button>
          <button class="home-button2 button" type="button">COPY CNC FILES TO WORKING DIRECTORY</button>
        </div>
        <input id="Directory" type="text" class="home-textinput3 input" />
        <label class="home-text4">CREO DRAWING:</label>
        <select id="CREODRAWING" class="home-select2">
          <option id="option1" value="Option 1">Option 1</option>
          <option value="Option 2">Option 2</option>
          <option value="Option 3">Option 3</option>
        </select>
      </form>
    </div>
  </div>
</body>
<script>
  // 当前模型名称
  let ModelName;
  let ModelNameDependencyName;
  let ParametersNames = ["REVISION", "DRAWING_NO", "PART_TYPE", "PART_NO", "LINE_NO", "MBPP"];
  let ParametersNames_ASM = new Map([
    ["JOB_NO", ],
    ["MN_CODE", ],
    ["MN_NUMBER", ],
    ["LINE", ],
    ["DWG_RL", ],
    ["PCR_NO", ],
    ["MBPP", ],
  ])
  let ParametersTypes = [103, 103, 102, 103, 103, 103];
  let ParametersValues = [];
  let ParametersValuesToChange = [];
  // document.pwl.eval("PWL_MODEL") -1
  // document.pwl.eval("PWL_FEATURE") 3
  // document.pwl.eval("PWL_VALUE_DOUBLE")  101
  // document.pwl.eval("PWL_VALUE_STRING")  102
  // document.pwl.eval("PWL_VALUE_INTEGER") 103
  // document.pwl.eval("PWL_VALUE_BOOLEAN") 104

  // 获取当前打开的模型名称
  function WlModelGetCurrent() {
    if (pfcIsMozilla())
      netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    var ret = document.pwl.pwlMdlCurrentGet();
    if (!ret.Status) {
      alert("pwlMdlCurrentGet failed (" + ret.ErrorCode + ")");
      window.close();
      return;
    }
    ModelName = ret.MdlNameExt;
  }

  //根据模型名获取地址
  function WlModelGetDirectory() {
    if (pfcIsMozilla())
      netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    var ret = document.pwl.pwlDirectoryCurrentGet();

    if (!ret.Status) {
      alert("pwlDirectoryCurrentGet failed (" + ret.ErrorCode + ")");
      return;
    }
    DirectoryPath = ret.DirectoryPath;
  }

  // 根据参数名，获取到模型的参数名对应的参数值
  function WlParametersGet(IS_MODEL) {
    if (pfcIsMozilla())
      netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");

    var ret;
    var FunctionName;
    // ItemType = document.pwl.eval(PWL_MODEL)
    var ItemType = parseInt((IS_MODEL) ? -1 : 3);
    var FeatureID = parseInt((IS_MODEL) ? -1 : 52);
    // var ParametersNames_TEMP = (IS_MODEL) ? ParametersNames.concat() : ParametersNames_ASM.concat();
    var FunctionName = (IS_MODEL) ? "pwlMdlParametersGet" : "pwlFeatureParametersGet";
    var ret = (IS_MODEL) ? document.pwl.pwlMdlParametersGet(ModelName) : document.pwl.pwlFeatureParametersGet(ModelName,
      FeatureID);

    if (ModelName == "") {
      return;
    }

    if (!ret.Status) {
      alert(FunctionName + " failed (" + ret.ErrorCode + ")");
      return;
    }

    for (i = 0; i < ret.NumParams; i++) {
      if (ParametersNames_ASM.has(ret.ParamNames.Item(i))) {
        var val_ret = document.pwl.pwlParameterValueGet(
          ModelName,
          parseInt(ItemType),
          FeatureID,
          ret.ParamNames.Item(i));

        if (!val_ret.Status) {
          alert("pwlParameterValueGet failed (" + val_ret.ErrorCode + ")");
          return;
        }

        var answer = "Undefined";
        if (val_ret.ParamType == parseInt(document.pwlc.PWL_VALUE_DOUBLE)) {
          answer = val_ret.ParamDoubleVal;
        } else if (val_ret.ParamType == parseInt(document.pwlc.PWL_VALUE_STRING)) {
          answer = val_ret.ParamStringVal;
        } else if (val_ret.ParamType == parseInt(document.pwlc.PWL_VALUE_INTEGER)) {
          answer = val_ret.ParamIntVal;
        } else if (val_ret.ParamType == parseInt(document.pwlc.PWL_VALUE_BOOLEAN)) {
          answer = (val_ret.ParamBooleanVal) ? "true" : "false";
        }
        ParametersNames_ASM.set(ret.ParamNames.Item(i), answer);
      }
    }
  }

  // 创建或修改参数
  function WlParameterSetValue(parameterName, parameterValue, ValueType) {
    if (pfcIsMozilla())
      netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");

    var FunctionName = "pwlParameterValueSet";
    // document.pwl.eval("PWL_MODEL");
    var ItemType = -1;
    var StringValue = parameterValue;
    var IntValue = parseInt(parameterValue);
    var FloatValue = parseFloat(parameterValue);
    var BoolValue = (parameterValue.toLowerCase() == "true") ? true : false;
    var featureID = -1;


    // In order to create usable trail file FloatValue cannot be NaN
    if (isNaN(FloatValue)) {
      FloatValue = 1.1;
    }
    if (isNaN(IntValue)) {
      IntValue = -5;
    }

    var ret = document.pwl.pwlParameterValueSet(
      ModelName,
      ItemType,
      featureID,
      parameterName,
      ValueType,
      IntValue, FloatValue, StringValue, BoolValue);

    if (!ret.Status) {
      alert(FunctionName + " failed (" + ret.ErrorCode + ")");
      return;
    }
  }

  // 创建或修改参数
  function WlParameterSetValue2(parameterName, parameterValue) {
    if (pfcIsMozilla())
      netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");

    var FunctionName = "pwlParameterValueSet";
    // document.pwl.eval("PWL_MODEL");
    var ItemType = 3;
    var StringValue = parameterValue;
    var IntValue = parseInt(parameterValue);
    var FloatValue = parseFloat(parameterValue);
    var BoolValue = (parameterValue.toLowerCase() == "true") ? true : false;
    var featureID = 52;
    var ValueType = 103;

    // In order to create usable trail file FloatValue cannot be NaN
    if (isNaN(FloatValue)) {
      FloatValue = 1.1;
    }
    if (isNaN(IntValue)) {
      IntValue = -5;
    }

    var ret = document.pwl.pwlParameterValueSet(
      ModelName,
      ItemType,
      featureID,
      parameterName,
      ValueType,
      IntValue, FloatValue, StringValue, BoolValue);

    if (!ret.Status) {
      alert(FunctionName + " failed (" + ret.ErrorCode + ")");
      return;
    }
  }

  function getParameters() {
    ParametersValuesToChange = [];
    ParametersValuesToChange.push($("#MNTYPE option:selected").val());
    ParametersNames_ASM.set("JOB_NO", $("#JOB").val());
    ParametersNames_ASM.set("MN_NUMBER", $("#MN").val());
    ParametersNames_ASM.set("LINE", $("#LINE").val());
    ParametersNames_ASM.set("DWG_RL", $("#REV").val());
    ParametersNames_ASM.set("MBPP", $("#MBPP").val());
  }

  // 根据给定的模型获取相关的依赖文件
  function WlModelGetDependencies() {
    if (pfcIsMozilla())
      netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    var ret = document.pwl.pwlMdlDependenciesGet(ModelName);
    if (!ret.Status) {
      alert("pwlMdlDependenciesGet failed (" + ret.ErrorCode + ")");
      return;
    }
    ModelNameDependencyName = [];
    for (var i = 0; i < ret.NumMdls; i++) {
      ModelNameDependencyName.push(ret.MdlNameExt.Item(i));
    }
    if (ModelNameDependencyName.length === 1) {
      ModelName = ModelNameDependencyName[0];
    }
  }

  $("#BookNumbers").click(function () {
    $.ajax({
      url: "http://mmkun-camsvr01:8080/system/CeroDraw/bookProgramNumber/3",
      type: 'get',
      async: false,
      // data: 3,
      // dataType: 'json',
      // 服务器返回的数据类型
      scrossDomain: true,
      success: function (result) {
        $("#PROG").text(result[0] + "\n" + result[1] + "\n" + result[2] + "\n");
      },
    });
  })


  function initTable() {
    WlModelGetCurrent();
    WlModelGetDependencies();
    WlModelGetDirectory();
    WlParametersGet(false);
    // $("#test").text(ParametersValues);
    // $("#test").text(document.pwl.eval("PWL_VALUE_STRING"));
    // $("#test2").text(document.pwl.eval("PWL_VALUE_DOUBLE"));
    // $("#test3").text(document.pwl.eval("PWL_VALUE_INTEGER"));
    // $("#test4").text(document.pwl.eval("PWL_VALUE_BOOLEAN"));

    $("#JOB").val(ParametersNames_ASM.get("JOB_NO"));
    $("[selected]").attr("selected", false);
    $("#SMN").attr("selected", "selected");
    $("#MN").val(ParametersNames_ASM.get("MN_NUMBER"));
    $("#LINE").val(ParametersNames_ASM.get("LINE"));
    $("#REV").val(ParametersNames_ASM.get("DWG_RL"));
    $("#PCR").val(ParametersNames_ASM.get("PCR_NO"));
    $("#MBPP").val(ParametersNames_ASM.get("MBPP"));
    // $("#Directory").val(DirectoryPath);
    $("#option1").html(ParametersNames_ASM.get("JOB_NO") + "SMN" + ParametersNames_ASM.get("MN_NUMBER") + "-" +
      ParametersNames_ASM.get("LINE"));
  }

  function updateJobInFor() {
    getParameters();
    // for (let index = 0; index < ParametersNames.length; index++) {
    //   $("#test").text(ParametersNames[index] + ParametersValuesToChange[index] + ParametersTypes[index]);
    //   WlParameterSetValue(ParametersNames[index], ParametersValuesToChange[index], ParametersTypes[index]);
    // }
    ParametersNames_ASM.forEach((value, key) => {
      $("#test").text(key)
      if (ParametersNames_ASM.get(key) != "") {
        WlParameterSetValue2(key, value)
      }
    });
  }

  initTable();
</script>

</html>